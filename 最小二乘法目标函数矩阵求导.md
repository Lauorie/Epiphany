##  最小二乘法目标函数矩阵求导

### 方法一：展开表达式，逐项求导（最直观）

这种方法不依赖于记忆复杂的矩阵求导公式，而是通过将矩阵乘法展开，利用我们熟悉的标量求导法则来完成。

**步骤 1: 展开 $S(\boldsymbol{\beta})$**

首先，我们把平方项展开：
$$ S(\boldsymbol{\beta}) = (\mathbf{y} - \mathbf{X}\boldsymbol{\beta})^T (\mathbf{y} - \mathbf{X}\boldsymbol{\beta}) $$
利用矩阵转置的性质 $(A-B)^T = A^T - B^T$ 和 $(AB)^T = B^T A^T$：
$$ (\mathbf{y} - \mathbf{X}\boldsymbol{\beta})^T = \mathbf{y}^T - (\mathbf{X}\boldsymbol{\beta})^T = \mathbf{y}^T - \boldsymbol{\beta}^T\mathbf{X}^T $$
现在将它代回原式，并像多项式乘法一样展开：
$$ S(\boldsymbol{\beta}) = (\mathbf{y}^T - \boldsymbol{\beta}^T\mathbf{X}^T) (\mathbf{y} - \mathbf{X}\boldsymbol{\beta}) $$
$$ S(\boldsymbol{\beta}) = \mathbf{y}^T\mathbf{y} - \mathbf{y}^T\mathbf{X}\boldsymbol{\beta} - \boldsymbol{\beta}^T\mathbf{X}^T\mathbf{y} + \boldsymbol{\beta}^T\mathbf{X}^T\mathbf{X}\boldsymbol{\beta} $$

**步骤 2: 简化表达式**

注意到中间的两项 $\mathbf{y}^T\mathbf{X}\boldsymbol{\beta}$ 和 $\boldsymbol{\beta}^T\mathbf{X}^T\mathbf{y}$。我们来分析它们的维度：
* $\mathbf{y}^T$ 是 $1 \times n$
* $\mathbf{X}$ 是 $n \times p$ (假设有 $p$ 个特征)
* $\boldsymbol{\beta}$ 是 $p \times 1$

所以 $\mathbf{y}^T\mathbf{X}\boldsymbol{\beta}$ 的最终维度是 $(1 \times n) \times (n \times p) \times (p \times 1) = 1 \times 1$，它是一个标量。

对于一个标量，它的转置等于它自身。我们来计算一下 $\boldsymbol{\beta}^T\mathbf{X}^T\mathbf{y}$ 的转置：
$$ (\boldsymbol{\beta}^T\mathbf{X}^T\mathbf{y})^T = \mathbf{y}^T (\mathbf{X}^T)^T (\boldsymbol{\beta}^T)^T = \mathbf{y}^T\mathbf{X}\boldsymbol{\beta} $$
因为它们都是标量，所以 $\boldsymbol{\beta}^T\mathbf{X}^T\mathbf{y} = \mathbf{y}^T\mathbf{X}\boldsymbol{\beta}$。

因此，我们可以合并中间两项：
$$ S(\boldsymbol{\beta}) = \mathbf{y}^T\mathbf{y} - 2\mathbf{y}^T\mathbf{X}\boldsymbol{\beta} + \boldsymbol{\beta}^T\mathbf{X}^T\mathbf{X}\boldsymbol{\beta} $$
*为了求导方便，我们通常写成 $2\boldsymbol{\beta}^T\mathbf{X}^T\mathbf{y}$ 的形式。*
$$ S(\boldsymbol{\beta}) = \mathbf{y}^T\mathbf{y} - 2\boldsymbol{\beta}^T(\mathbf{X}^T\mathbf{y}) + \boldsymbol{\beta}^T(\mathbf{X}^T\mathbf{X})\boldsymbol{\beta} $$

**步骤 3: 逐项对 $\boldsymbol{\beta}$ 求导**

现在我们对 $S(\boldsymbol{\beta})$ 的三项分别求导。这里需要用到两个基本的向量求导法则：
1.  **线性项**: $\frac{\partial (\mathbf{a}^T \boldsymbol{\beta})}{\partial \boldsymbol{\beta}} = \frac{\partial (\boldsymbol{\beta}^T \mathbf{a})}{\partial \boldsymbol{\beta}} = \mathbf{a}$
2.  **二次项**: $\frac{\partial (\boldsymbol{\beta}^T \mathbf{A} \boldsymbol{\beta})}{\partial \boldsymbol{\beta}} = (\mathbf{A} + \mathbf{A}^T)\boldsymbol{\beta}$。如果 $\mathbf{A}$ 是对称矩阵（即 $\mathbf{A} = \mathbf{A}^T$），则导数为 $2\mathbf{A}\boldsymbol{\beta}$。

让我们应用这些法则：

*   **第一项**: $\mathbf{y}^T\mathbf{y}$ 不含 $\boldsymbol{\beta}$，所以 $\frac{\partial (\mathbf{y}^T\mathbf{y})}{\partial \boldsymbol{\beta}} = \mathbf{0}$。

*   **第二项**: $-2\boldsymbol{\beta}^T(\mathbf{X}^T\mathbf{y})$。这符合线性项 $\boldsymbol{\beta}^T \mathbf{a}$ 的形式，其中 $\mathbf{a} = \mathbf{X}^T\mathbf{y}$。
    所以，$\frac{\partial (-2\boldsymbol{\beta}^T\mathbf{X}^T\mathbf{y})}{\partial \boldsymbol{\beta}} = -2\mathbf{X}^T\mathbf{y}$。

*   **第三项**: $\boldsymbol{\beta}^T(\mathbf{X}^T\mathbf{X})\boldsymbol{\beta}$。这符合二次项 $\boldsymbol{\beta}^T \mathbf{A} \boldsymbol{\beta}$ 的形式，其中 $\mathbf{A} = \mathbf{X}^T\mathbf{X}$。
    我们需要检查 $\mathbf{A}$ 是否对称：$(\mathbf{X}^T\mathbf{X})^T = \mathbf{X}^T(\mathbf{X}^T)^T = \mathbf{X}^T\mathbf{X}$。确实是对称矩阵。
    因此，$\frac{\partial (\boldsymbol{\beta}^T\mathbf{X}^T\mathbf{X}\boldsymbol{\beta})}{\partial \boldsymbol{\beta}} = 2(\mathbf{X}^T\mathbf{X})\boldsymbol{\beta}$。

**步骤 4: 合并结果**

将三项的导数加起来：
$$ \frac{\partial S(\boldsymbol{\beta})}{\partial \boldsymbol{\beta}} = \mathbf{0} - 2\mathbf{X}^T\mathbf{y} + 2\mathbf{X}^T\mathbf{X}\boldsymbol{\beta} $$
$$ = 2\mathbf{X}^T\mathbf{X}\boldsymbol{\beta} - 2\mathbf{X}^T\mathbf{y} $$
提取公因式 $-2\mathbf{X}^T$：
$$ = -2\mathbf{X}^T(\mathbf{y} - \mathbf{X}\boldsymbol{\beta}) $$
推导完成！

---

### 方法二：使用矩阵链式法则（更简洁）

这种方法需要你熟悉矩阵求导的链式法则，对于熟悉的人来说更快。

**步骤 1: 设定变量**

令 $\boldsymbol{\epsilon} = \mathbf{y} - \mathbf{X}\boldsymbol{\beta}$。
那么 $S = \boldsymbol{\epsilon}^T \boldsymbol{\epsilon}$。

**步骤 2: 应用链式法则**

我们要求的是 $\frac{\partial S}{\partial \boldsymbol{\beta}}$。根据链式法则，我们可以写成：
$$ \frac{\partial S}{\partial \boldsymbol{\beta}} = \left(\frac{\partial \boldsymbol{\epsilon}}{\partial \boldsymbol{\beta}}\right)^T \frac{\partial S}{\partial \boldsymbol{\epsilon}} $$
*注意：这里的链式法则形式是 Jacobian 转置乘以梯度，这是向量对向量求导的一种常见形式。*

**步骤 3: 分别计算导数**

*   **计算 $\frac{\partial S}{\partial \boldsymbol{\epsilon}}$**:
    $S = \boldsymbol{\epsilon}^T \boldsymbol{\epsilon} = \sum_i \epsilon_i^2$。这是一个简单的二次型。
    $\frac{\partial S}{\partial \boldsymbol{\epsilon}}$ 的第 $j$ 个元素是 $\frac{\partial S}{\partial \epsilon_j} = 2\epsilon_j$。
    因此，$\frac{\partial S}{\partial \boldsymbol{\epsilon}} = 2\boldsymbol{\epsilon}$。

*   **计算 $\frac{\partial \boldsymbol{\epsilon}}{\partial \boldsymbol{\beta}}$**:
    $\boldsymbol{\epsilon} = \mathbf{y} - \mathbf{X}\boldsymbol{\beta}$。
    $\frac{\partial \boldsymbol{\epsilon}}{\partial \boldsymbol{\beta}} = \frac{\partial (\mathbf{y} - \mathbf{X}\boldsymbol{\beta})}{\partial \boldsymbol{\beta}} = \frac{\partial \mathbf{y}}{\partial \boldsymbol{\beta}} - \frac{\partial (\mathbf{X}\boldsymbol{\beta})}{\partial \boldsymbol{\beta}}$。
    $\mathbf{y}$ 是常数向量，所以 $\frac{\partial \mathbf{y}}{\partial \boldsymbol{\beta}} = \mathbf{0}$。
    根据法则 $\frac{\partial (\mathbf{A}\mathbf{x})}{\partial \mathbf{x}} = \mathbf{A}$，我们有 $\frac{\partial (\mathbf{X}\boldsymbol{\beta})}{\partial \boldsymbol{\beta}} = \mathbf{X}$。
    所以，$\frac{\partial \boldsymbol{\epsilon}}{\partial \boldsymbol{\beta}} = -\mathbf{X}$。

**步骤 4: 合并结果**

将计算出的导数代入链式法则公式：
$$ \frac{\partial S}{\partial \boldsymbol{\beta}} = (-\mathbf{X})^T (2\boldsymbol{\epsilon}) $$
$$ = -\mathbf{X}^T (2\boldsymbol{\epsilon}) $$
$$ = -2\mathbf{X}^T \boldsymbol{\epsilon} $$
最后，将 $\boldsymbol{\epsilon} = \mathbf{y} - \mathbf{X}\boldsymbol{\beta}$ 代回：
$$ \frac{\partial S(\boldsymbol{\beta})}{\partial \boldsymbol{\beta}} = -2\mathbf{X}^T(\mathbf{y} - \mathbf{X}\boldsymbol{\beta}) $$


两种方法都得到了相同的结果，但第一种方法通过展开，能更清楚地看到每一个部分的来源，而第二种方法则展示了矩阵微积分工具的强大与简洁。
